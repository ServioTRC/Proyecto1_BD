<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Agregar/Editar Producto</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="scripts/jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="style/bootstrap.css" />
    <script src="scripts/bootstrap.js"></script>
    <link rel="stylesheet" href="style/font-awesome.min.css" />
    <script src="scripts/JsStore-1.1.4.min.js "></script>
    <style>
        /* Popup container - can be anything you want */
        .popup {
            position: relative;
            display: inline-block;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* The actual popup */
        .popup .popuptext {
            visibility: hidden;
            width: 160px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
        }
        
        /* Popup arrow */
        .popup .popuptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        
        /* Toggle this class - hide and show the popup */
        .popup .show {
            visibility: visible;
            -webkit-animation: fadeIn 1s;
            animation: fadeIn 1s;
        }
        
        /* Add animation (fade in the popup) */
        @-webkit-keyframes fadeIn {
            from {opacity: 0;} 
            to {opacity: 1;}
        }
        
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity:1 ;}
        }
    </style>
    <script>

        // Cargar la BD
        var DbConnection,
            ProductoID;
        window.onload = function () {
            initiateDb();
        };


        function initiateDb() {
            var DbName = "Catalogo";
            JsStore.isDbExist(DbName, function (isExist) {
                if (isExist) { // Si la base de datos ya existe
                    DbConnection = new JsStore.Instance(DbName);
                    onDbInitiated();
                } else { // Regresar al menu principal
                    alert("Error en Base de Datos");
                    window.location.href = "PaginaInicio.html";
                }
            });
        };

        function onDbInitiated() {
            ProductoID = getQsValueByName('id');

            if (ProductoID) {
                DbConnection.select({
                    From: "Marca",
                    Where: {
                        ID_Marca: parseInt(ProductoID)
                    }
                }, function (marcas) {
                    if (marcas.length == 1) {
                        $('#txtNombreProducto').val(marcas[0].Nombre);
                        $('#txtCategoria').val(marcas[0].Correo);
                        $('#txtMarca').val(marcas[0].Telefono);
                        $('#txtImagen').val(marcas[0].Imagen);
                        $('#txtTiendas').val(marcas[0].Tiendas);
                        $('#txtPrecio').val(marcas[0].Precio_Promedio);
                    }
                    else {
                        alert('Invalid id');
                    }

                }, function (error) {
                    alert(error.Message);
                });
            }
        }

        function Submit() {
            if (ProductoID) {
                updateProduct();
            } else {
                agregarMarca();
            }
        }
        
        function validarURL(url) {
            var re =  /^(?:(?:https?|ftp):\/\/)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/;
            return re.test(String(url).toLowerCase());
        }

        function updateProduct() {
            var value = [{
                Nombre: $('#txtNombreProducto').val(),
                Categoria: $('#txtCategoria').val(),
                Marca: $('#txtMarca').val(),
                Imagen: $('#txtImagen').val(),
                Tiendas: $('#txtImagen').val(),
                Precio_Promedio: parseFloat($('#txtImagen').val())
            }];

            var url_valido = validarURL(value[0].Pagina_Web);
            if(url_valido){
                DbConnection.select({
                    From: "Marca",
                    Where: {
                        ID_Marca: ProductoID
                    }
                }, function (results) {
                    if (results.length > 0) {
                        connection.update({ 
                            in: "Marca",
                            set: value,
                            where: {
                                ID_Marca: ProductoID,
                            }
                        }).then(function(rowsUpdated) {
                            alert("Registro actualizado");
                        }).catch(function(err) {
                            console.log(err);
                        });
                    } else {
                        alert('Error editando registro');
                    }

                }, function (error) {
                    alert(error.Message);
                });
            } else {
                alert("Página Web de la imágen inválida");
            }           
        }

        function agregarMarca() {
            var value = [{
                Nombre: $('#txtNombreProducto').val(),
                Correo: $('#txtCategoria').val(),
                Telefono: $('#txtMarca').val(),
                Pagina_Web: $('#txtImagen').val()
            }];
            var correo_valido = validarCorreo(value[0].Correo);
            var url_valido = validarURL(value[0].Pagina_Web);
            if(correo_valido && url_valido){
                DbConnection.select({
                    From: "Marca",
                    Where: {
                        Nombre: String(value[0].Nombre)
                    }
                }, function (results) {
                    console.log(value[0].Nombre);
                    if (results.length > 0) {
                        alert('Ya existe una Marca con este Nombre');
                    } else {
                        DbConnection.insert({
                            Into: "Marca",
                            Values: value
                        }, function (rowsAdded) {
                            alert('Marca Agregada');
                            $('#txtNombreProducto').val("");
                            $('#txtCategoria').val("");
                            $('#txtMarca').val("");
                            $('#txtImagen').val("");
                        }, function (err) {
                            console.log(err);
                            alert("Ocurrió un error al agregar la marca");
                        });                  
                    }
                }, function (error) {
                    alert(error.Message);
                });
            } else if(!correo_valido && !url_valido){
                alert("Correo y Página Web inválidas");
            }  else if(!correo_valido){
                alert("Correo inválido");
            } else if(!url_valido){
                alert("Página Web inválida");
            } 
        }

        function returnMarcas(){
            window.location.href = "Productos.html";
        }

        // When the user clicks on div, open the popup
        function showPopUpTienda() {
            var popup = document.getElementById("myPopupTienda");
            popup.classList.toggle("show");
            setTimeout(function () { popup.classList.toggle("show");}, 3000);
        }

        // When the user clicks on div, open the popup
        function showPopUpImagen() {
            var popup = document.getElementById("myPopupImagen");
            popup.classList.toggle("show");
            setTimeout(function () { popup.classList.toggle("show");}, 3000);
        }
    </script>
</head>
<body>
    <div class="row row-centered">
        <div class="col-xs-11 col-sm-8 col-centered">
            <h1 align="center" >Crear o Actualizar un Producto</h1>
                <form class="form-horizontal" data-student-id="" role="form" style="margin-top:50px;">
                    <div class="form-group">
                        <label class="control-label col-sm-3" for="txtNombreProducto">Nombre del producto:</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control" id="txtNombreProducto" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-3" for="txtCategoria">Categoría:</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control" id="txtCategoria" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-3" for="txtMarca">Marca:</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control" id="txtMarca" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-3 popup" onclick="showPopUpImagen()" for="txtImagen">URL de la Imagen &#9432;:
                            <span class="popuptext" id="myPopupImagen">Dejar vacío en caso de no haber</span>
                        </label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control" id="txtImagen" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-3 popup" onclick="showPopUpTienda()" for="txtTiendas">Tiendas &#9432;:
                            <span class="popuptext" id="myPopupTienda">Ingresar las tiendas separadas por una coma</span>
                        </label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control" id="txtTiendas" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-3" for="txtPrecio">Precio Promedio:</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control" id="txtPrecio" />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-12" style="text-align:center;margin-top:30px;">
                            <button id="btnSubmit" type="button" onclick="Submit();" class="btn btn-primary" style="padding:9px 15px 9px 15px;">
                                <i class="fa fa-check" aria-hidden="true"></i> <span>Ok</span>
                            </button>
                            <button id="btnCancel" type="button" onclick="returnMarcas();" class="btn btn-warning" style="padding:9px 15px 9px 15px;">
                                <i class="fa fa-warning" aria-hidden="true"></i> <span>Cancelar</span>
                            </button>
                        </div>
                    </div>
                </form>
        </div>
    </div>
    <link href="style/main.css " rel="stylesheet " type="text/css " />
    <script>
        function getQsValueByName(name, url) {
            if (!url) {
                url = window.location.href;
            }
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

    </script>
</body>
</html>
