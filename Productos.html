<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:margin-right="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Catálogo de Productos</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="scripts/jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="style/bootstrap.css" />
    <script src="scripts/bootstrap.js"></script>
    <link rel="stylesheet" href="style/font-awesome.min.css" />
    <link href="https://fonts.googleapis.com/css?family=Slabo+27px" rel="stylesheet">
    <script src="scripts/JsStore-1.1.4.min.js "></script>
    <script>

        // Cargar la BD
        var DbConnection, nombre_marca;

        window.onload = function () {
            initiateDb();
        };

        function initiateDb() {
            var DbName = "Catalogo";
            JsStore.isDbExist(DbName, function (isExist) {
                if (isExist) { // Si la base de datos ya existe
                    DbConnection = new JsStore.Instance(DbName);
                    onDbInitiated();
                } else { // Regresar al menu principal
                    alert("Error en Base de Datos");
                    window.location.href = "PaginaInicio.html";
                }
            });
        };
        
        //CORREGIR
        function generar_JSON(){
            DbConnection.select({
                From: "Producto",
            }, function (productos) {
                alert(JSON.stringify(productos));
            });
        }

        // Crear conexion elementos pantalla
        window.onload = function () {
            initiateDb();

            // Boton de prueba
            $('#btnInicio').click(function () {
                var Result = confirm('¿Estás seguro de regresar al Inicio?\nSe reiniciará la base de datos');
                if (Result) {
                    DbConnection.dropDb();
                    window.location.href = "PaginaInicio.html";
                }
            });

            // Vincular Botón Ver Lectores
            $('#btnMarcas').on('click',function () {
                //alert("Cambio a Lectores");
                window.location.href = 'Marcas.html';
            });

            // Vincular Botón Editar
            $('#tblGrid tbody').on('click', '.edit', function () {
                var PrestamoId = $(this).parents().eq(1).attr('itemid');
                window.location.href = 'AgregarProducto.html?id=' + PrestamoId;
            });

            // Vincular botón Borrar
            $('#tblGrid tbody').on('click', '.delete', function () {
                var Result = confirm('¿Estás seguro de borrar este producto?');
                if (Result) {
                    var id_producto = $(this).parents().eq(1).attr('itemid');
                    console.log("Borrando id_producto: " + id_producto);
                    borrar_producto(Number(id_producto));
                }
            });

            // Cambiar a página Agregar Producto
            $('#btnAgrProducto').click(function () {
                window.location.href = 'AgregarProducto.html';
            });

            //Funcion para Exportar a JSON
            $('#btnExportar').click(function () {
                generar_JSON();
            });
        };

        // Borrar registro de tabla por ID
        function borrar_producto(id_producto) {
            DbConnection.delete({
                From: "Producto",
                Where: {
                    ID_Producto: id_producto
                }
            }, function (rowsDeleted) {
                console.log(rowsDeleted + ' rows deleted');
                if (rowsDeleted > 0) {
                    showTableData();
                    alert("Se eliminó el registro");
                }
            }, function (error) {
                alert(error.Message);
            })
        }

        // Mostrar Registros
        function onDbInitiated() {
            showTableData();
        }

        // Insertar Préstamo
        function insertPrestamo() {
            var Prestamos = getPrestamos();
            DbConnection.insert({
                Into: "Prestamo",
                Values: Prestamos
            }, function (rowsAdded) {

            }, function (err) {
                console.log(err);
                alert('Error Occured while adding data')
            })
        }

        // Desplegar los registros
        function showTableData() {
            DbConnection.select({
                From: "Producto"
            }, function (productos) {
                var HtmlString = "";
                productos.forEach(function (producto) {
                    HtmlString += "<tr ItemId=" + producto.ID_Producto + "><td>" +
                        producto.Nombre + "</td><td>" +
                        producto.Categoria + "</td><td>";

                    HtmlString += producto.Marca + "</td><td>";

                    if(producto.Imagen != "N/A"){
                        HtmlString += "<img src=" + producto.Imagen + " width=\"150\" height=\"150\"/> </td><td>";
                    } else {
                        HtmlString += producto.Imagen + "</td><td>";
                    }
                    
                    HtmlString += "<ul>";

                    for (var i = 0; i < producto.Tiendas.length; i++) {
                        HtmlString += "<li>" + producto.Tiendas[i] + "</li>";
                    } 

                    HtmlString += "</ul></td><td>" +
                        "$" + producto.Precio_Promedio + " MXN</td><td>" +
                        "<a href='#' class='edit'>Editar</a></td>" +
                        "<td><a href='#' class='delete''>Eliminar</a></td>";
                    

                }, function (error) {
                    console.log(error);
                });
                $('#tblGrid tbody').html(HtmlString);
            });
        }

    </script>
</head>
<body>
    <div class="row row-centered " style="margin-top:10px; ">
        <div class="col-xs-12 col-sm-10 col-centered">
            <nav>
                <div style="text-align:center;">
                    <button id="btnMarcas" class="btn btn-info"><i class="fa fa-user-circle" aria-hidden="true"></i> Marcas Registradas</button>
                    <button id="btnAgrProducto" class="btn btn-primary"><i class="fa fa-plus" aria-hidden="true"></i> Producto Nuevo</button>
                    <button id="btnExportar" class="btn btn-primary"><i class="fa fa-plus" aria-hidden="true"></i> Exportar a JSON</button>
                    <button id="btnInicio" class="btn btn-warning"><i class="fa fa-book" aria-hidden="true"></i> Restaurar Sistema</button>
                </div>
            </nav>

            <table id="tblGrid" class="table table-hover ">
                <caption style="text-align:center;padding:7px 0px 7px 0px;background:#005B96;color:white;font-family:'Slabo 27px', serif;font-size:20px; ">Detalles de los Productos</caption>
                <thead>
                    <tr>
                        <th>Nombre del Producto</th>
                        <th>Categoría del Producto</th>
                        <th>Marca</th>
                        <th>Imagen</th>
                        <th>Tiendas</th>
                        <th>Precio Promedio</th>
                        <th></th>
            			<th></th>
                    </tr>
                </thead>
                <tbody></tbody> <!--Aquí se agregan los valores de los registros de los productos-->
            </table>
        </div>
    </div>
    <link href="style/main.css " rel="stylesheet " type="text/css " />
</body>
</html>
